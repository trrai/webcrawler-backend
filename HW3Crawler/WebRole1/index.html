<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>CR4WL3R</title>
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"
            integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
            crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.6.0/Chart.min.js" type="text/javascript"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">

</head>
<body>
    <button id="start" class="btn btn-success">START Crawling</button>
    <button id="stop" class="btn btn-danger">STOP Crawling</button>
    <h2> Status: <span id="status" class="label label-primary"> </span></h2>

    <h2>Last Ten Crawled:</h2>
    <button id="fetchLastTen_button" class="btn btn-info">Fetch Last 10 Crawled</button>
    <ul id="results" class="list-group"></ul>

    <h2>Performance: </h2>
    <button id="performance_button" class="btn btn-info">Fetch Performance</button>
    <ul id="performance_results" class="list-group"></ul>

    <button id="update_chart" class="btn btn-info">Update Chart</button>
    <div style="width:75%;height:75%">
        <canvas id="myChart" style="padding: 0;margin: auto;display: block; "> </canvas>
    </div>

</body>
<script>

    $(document).ready(function () {
        // run the first time; all subsequent calls will take care of themselves
        setInterval(performanceRequest, 1000);
        setInterval(fetchLastTenRequest, 5000);
        setInterval(updateStatus, 2000);
        makeChart();
        
    });

    var fetchLastTenButton = document.getElementById('fetchLastTen_button');
    var performanceButton = document.getElementById('performance_button');
    var startButton = document.getElementById('start');
    var stopButton = document.getElementById('stop');
    var updateChartButton = document.getElementById('update_chart');

    fetchLastTenButton.addEventListener('click', function () {
        fetchLastTenRequest();
    })

    performanceButton.addEventListener('click', function () {
        performanceRequest();
    })

    startButton.addEventListener('click', function () {
        startRequest();
    })

    stopButton.addEventListener('click', function () {
        stopRequest();
    })

    updateChartButton.addEventListener('click', function () {
        updateChart();
    })
    //function to update chart
    function updateChart() {
        $.ajax({
            type: "POST",
            url: "Admin.asmx/GetPerformanceChartData",
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (msg) {
                console.log("Success");
                //if results are not returned 
                if (!eval(msg)["d"]) {
                    $("#myChart").append("<p> No results found </p>");
                }
                //otherwise append the results found
                else {
                    console.log("Updating chart..");
                    var cpuData = [];
                    var memData = [];
                    for (var i in eval(msg)["d"]) {
                        var stats = eval(msg)["d"][i].split("|");
                        cpuData.push(stats[0]);
                        memData.push(stats[1]/100);
                    }

                    config.data.datasets = [{
                        label: "CPU",
                        backgroundColor: '#FF0000',
                        borderColor: '#FF0000',
                        data: cpuData,
                        fill: false,
                    }, {
                        label: "RAM",
                        fill: false,
                        backgroundColor: '#008000',
                        borderColor: '#008000',
                        data: memData,
                        }];

                    window.myLineChart.update();
                }

            },
            error: function (msg) {
                console.log("error: " + msg);
            }
        });
    }

    var cpuInitData = [];
    var memInitData = [];

    var config = {
        type: 'line',
        data: {
            labels: ["1", "2", "3", "4", "5", "6", "7", "8", "9", "10"],
            datasets: [{
                label: "CPU",
                backgroundColor: '#FF0000',
                borderColor: '#FF0000',
                data: cpuInitData,
                fill: false,
            }, {
                label: "RAM",
                fill: false,
                backgroundColor: '#008000',
                borderColor: '#008000',
                data: memInitData,
            }]
        },
        options: {
            responsive: true,
            title: {
                display: true,
                text: 'Performance'
            },
            tooltips: {
                mode: 'index',
                intersect: false,
            },
            hover: {
                mode: 'nearest',
                intersect: true
            },
            scales: {
                xAxes: [{
                    display: true,
                    scaleLabel: {
                        display: true,
                        fontSize: 18,
                        labelString: 'Time Interval'
                    },
                    ticks: {
                        fontSize: 15
                    }
                }],
                yAxes: [{
                    display: true,
                    scaleLabel: {
                        display: true,
                        fontSize: 18,
                        labelString: 'Value (RAM x100)'
                    },
                    ticks: {
                        fontSize: 15
                    }

                }]
            }
        }
    };
    //function to create chart
    function makeChart() {
        $.ajax({
            type: "POST",
            url: "Admin.asmx/GetPerformanceChartData",
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (msg) {
                console.log("Success");
                //if results are not returned 
                if (!eval(msg)["d"]) {
                    $("#myChart").append("<p> No results found </p>");
                }
                //otherwise append the results found
                else {
                    
                    for (var i in eval(msg)["d"]) {
                        var stats = eval(msg)["d"][i].split("|");
                        cpuInitData.push(stats[0]);
                        memInitData.push(stats[1]/100);
                    }

                    var ctx = document.getElementById("myChart").getContext("2d");
                    window.myLineChart = new Chart(ctx, config);

                }

            },
            error: function (msg) {
                console.log("error: " + msg);
            }
        });
    }
    //function to update status
    function updateStatus() {

        $.ajax({
            type: "POST",
            url: "Admin.asmx/GetStatus",
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (msg) {
                $('#status').text(eval(msg)["d"].replace(/['"]+/g, ''));
            },
            error: function (msg) {
                console.log("error: " + msg);
            }
        });
    };
    //function to start
    function startRequest() {

        $.ajax({
            type: "POST",
            url: "Admin.asmx/StartCrawl",
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (msg) {
                console.log("STARTED!");
               
            },
            error: function (msg) {
                console.log("error: " + msg);
            }
        });
    };
    //function to stop
    function stopRequest() {

        $.ajax({
            type: "POST",
            url: "Admin.asmx/StopCrawl",
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (msg) {
                console.log("STOPPED!");

            },
            error: function (msg) {
                console.log("error: " + msg);
            }
        });
    };
    //function to send performance request
    function performanceRequest() {

        $.ajax({
            type: "POST",
            url: "Admin.asmx/GetPerformance",
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (msg) {
                console.log("Success");
                $('#performance_results').empty();
                //if results are not returned 
                if (!eval(msg)["d"]) {
                    $("#performance_results").append("<p> No results found </p>");
                }
                //otherwise append the results found
                else {
                    var index = 1;
                    for (var i in eval(msg)["d"]) {
                        $("#performance_results").append("<li class='list-group-item'>" + eval(msg)["d"][i] + "</li>");
                        index++;
                    }
                }

            },
            error: function (msg) {
                console.log("error: " + msg);
            }
        });
    };
    //function to send the ajax request and append the data appropriately
    function fetchLastTenRequest() {

        $.ajax({
            type: "POST",
            url: "Admin.asmx/GetLast10Added",
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (msg) {
                console.log("Success");
                $('#results').empty();
                //if results are not returned 
                if (!eval(msg)["d"]) {
                    $("#results").append("<p> No results found </p>");
                }
                //otherwise append the results found
                else {
                    var index = 1;
                    for (var i in eval(msg)["d"]) {
                        $("#results").append("<li class='list-group-item'>" + index.toString() + ". " +
                            "<a target='_blank' href= '" + eval(msg)["d"][i] + "'>" + eval(msg)["d"][i] + "</li>");
                        index++;
                    }
                }

            },
            error: function (msg) {
                console.log("error: " + msg);
            }
        });
    };
</script>
</html>